<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mafia Matrix Death Detective System</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background-color: #111827;
            color: #e5e7eb;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Header Styles */
        .header {
            background-color: #1f2937;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        .title {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }
        
        .skull {
            color: #ef4444;
            font-size: 2rem;
        }
        
        /* Stats Display */
        .stats-container {
            display: flex;
            justify-content: center;
            gap: 32px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        
        .stat-box {
            text-align: center;
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: #9ca3af;
        }
        
        /* City Stats */
        .city-stats {
            border-top: 1px solid #374151;
            padding-top: 16px;
            display: flex;
            justify-content: center;
            gap: 24px;
            flex-wrap: wrap;
        }
        
        .city-box {
            text-align: center;
        }
        
        /* Tabs */
        .tabs {
            background-color: #1f2937;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        .tab-buttons {
            display: flex;
            flex-wrap: wrap;
            border-bottom: 1px solid #374151;
        }
        
        .tab-button {
            padding: 12px 24px;
            font-weight: 500;
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .tab-button:hover {
            color: #e5e7eb;
        }
        
        .tab-button.active {
            background-color: #374151;
            color: white;
        }
        
        .tab-content {
            padding: 24px;
        }
        
        .tab-panel {
            display: none;
        }
        
        .tab-panel.active {
            display: block;
        }
        
        /* Forms and Inputs */
        .input-group {
            margin-bottom: 16px;
        }
        
        .textarea {
            width: 100%;
            min-height: 200px;
            background-color: #374151;
            border: 1px solid #4b5563;
            border-radius: 4px;
            padding: 12px;
            color: white;
            font-family: monospace;
            font-size: 0.875rem;
            resize: vertical;
        }
        
        .input {
            background-color: #374151;
            border: 1px solid #4b5563;
            border-radius: 4px;
            padding: 8px 12px;
            color: white;
        }
        
        .select {
            background-color: #374151;
            border: 1px solid #4b5563;
            border-radius: 4px;
            padding: 8px 12px;
            color: white;
            cursor: pointer;
        }
        
        /* Buttons */
        .button {
            padding: 8px 16px;
            border-radius: 4px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .button-primary {
            background-color: #10b981;
            color: white;
        }
        
        .button-primary:hover {
            background-color: #059669;
        }
        
        .button-primary:disabled {
            background-color: #4b5563;
            cursor: not-allowed;
        }
        
        .button-secondary {
            background-color: #6b7280;
            color: white;
        }
        
        .button-secondary:hover {
            background-color: #4b5563;
        }
        
        .button-danger {
            background-color: #ef4444;
            color: white;
        }
        
        .button-danger:hover {
            background-color: #dc2626;
        }
        
        .button-group {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }
        
        /* Alerts */
        .alert {
            background-color: #eab308;
            color: #1c1917;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 16px;
        }
        
        .alert-error {
            background-color: #ef4444;
            color: white;
        }
        
        .alert-success {
            background-color: #10b981;
            color: white;
        }
        
        /* Table */
        .table-container {
            overflow-x: auto;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table th {
            text-align: left;
            padding: 8px;
            border-bottom: 1px solid #374151;
            font-weight: 500;
            cursor: pointer;
            user-select: none;
        }
        
        .table th:hover {
            color: #60a5fa;
        }
        
        .table td {
            padding: 8px;
            border-bottom: 1px solid #374151;
        }
        
        .table tr:hover {
            background-color: #374151;
        }
        
        .table tr.dead {
            opacity: 0.5;
        }
        
        /* Player Status Badges */
        .status-badge {
            font-size: 0.875rem;
            margin-right: 4px;
        }
        
        .player-link {
            color: #60a5fa;
            cursor: pointer;
            text-decoration: none;
        }
        
        .player-link:hover {
            color: #93bbfc;
            text-decoration: underline;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background-color: #1f2937;
            border-radius: 8px;
            padding: 24px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            width: 600px;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .close-button {
            background: none;
            border: none;
            color: #9ca3af;
            font-size: 24px;
            cursor: pointer;
        }
        
        .close-button:hover {
            color: white;
        }
        
        /* Game Menu */
        .game-menu {
            max-width: 400px;
            margin: 100px auto;
            background-color: #1f2937;
            padding: 32px;
            border-radius: 8px;
            text-align: center;
        }
        
        .game-code-input {
            width: 100%;
            padding: 12px;
            background-color: #374151;
            border: 1px solid #4b5563;
            border-radius: 4px;
            color: white;
            font-size: 1.25rem;
            font-family: monospace;
            text-align: center;
            letter-spacing: 2px;
            margin-bottom: 8px;
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 100px;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 48px;
            height: 48px;
            border: 3px solid #374151;
            border-top-color: #60a5fa;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            z-index: 1001;
            max-width: 400px;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Game Status Bar */
        .status-bar {
            position: fixed;
            top: 16px;
            left: 16px;
            background-color: #1f2937;
            padding: 8px 16px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            z-index: 999;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .status-indicator.connected {
            background-color: #10b981;
        }
        
        .status-indicator.disconnected {
            background-color: #ef4444;
        }
        
        /* Combat Stats */
        .combat-stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 16px;
        }
        
        .combat-stat-box {
            background-color: #374151;
            padding: 16px;
            border-radius: 4px;
            text-align: center;
        }
        
        .combat-stat-number {
            font-size: 2rem;
            font-weight: bold;
        }
        
        .combat-stat-label {
            color: #9ca3af;
            font-size: 0.875rem;
        }
        
        .combat-stat-buttons {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 8px;
        }
        
        .icon-button {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Manual Add Form */
        .manual-add-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 12px;
        }
        
        /* Top Survivors */
        .survivors-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        
        .survivor-list {
            background-color: #374151;
            padding: 16px;
            border-radius: 4px;
        }
        
        .survivor-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
        }
        
        /* Death Report */
        .death-list {
            background-color: #374151;
            padding: 16px;
            border-radius: 4px;
            max-height: 256px;
            overflow-y: auto;
        }
        
        .death-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        /* Career History */
        .career-item {
            border-left: 4px solid #4b5563;
            padding-left: 16px;
            margin-bottom: 12px;
        }
        
        .career-item.current {
            border-left-color: #10b981;
        }
        
        /* Hidden */
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Game Status Bar -->
    <div id="statusBar" class="status-bar hidden">
        <div>
            <span style="color: #9ca3af; font-size: 0.875rem;">Game Code:</span>
            <span id="gameCodeDisplay" style="margin-left: 8px; font-weight: bold; color: #10b981; font-family: monospace; font-size: 1.125rem;"></span>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
            <span id="connectionIndicator" class="status-indicator connected"></span>
            <span id="connectionText" style="font-size: 0.875rem; color: #9ca3af;">Connected</span>
        </div>
        <button onclick="leaveGame()" style="font-size: 0.875rem; color: #ef4444; background: none; border: none; cursor: pointer;">Leave</button>
    </div>

    <!-- Game Menu -->
    <div id="gameMenu" class="game-menu hidden">
        <h1 style="font-size: 2rem; font-weight: bold; margin-bottom: 8px;">
            <span class="skull">💀</span> MAFIA MATRIX <span class="skull">💀</span>
        </h1>
        <p style="color: #9ca3af; margin-bottom: 32px;">Death Detective System</p>
        
        <div style="display: flex; flex-direction: column; gap: 16px;">
            <button onclick="createNewGame()" class="button button-primary" style="width: 100%; padding: 12px;">
                ➕ Create New Game
            </button>
            
            <div style="position: relative; margin: 16px 0;">
                <div style="position: absolute; inset: 0; display: flex; align-items: center;">
                    <div style="width: 100%; border-top: 1px solid #4b5563;"></div>
                </div>
                <div style="position: relative; display: flex; justify-content: center;">
                    <span style="padding: 0 8px; background-color: #1f2937; color: #9ca3af; font-size: 0.875rem;">OR</span>
                </div>
            </div>
            
            <div>
                <input type="text" id="joinGameCode" placeholder="Enter Game Code" maxlength="6" 
                       class="game-code-input" onkeypress="handleJoinKeyPress(event)">
                <button onclick="joinGameFromInput()" class="button button-primary" 
                        style="width: 100%; padding: 12px;" disabled id="joinButton">
                    Join Game
                </button>
            </div>
        </div>
        
        <p style="margin-top: 32px; font-size: 0.875rem; color: #6b7280;">
            Share the game code with others to collaborate in real-time
        </p>
    </div>

    <!-- Loading Screen -->
    <div id="loading" class="loading hidden">
        <div class="loading-spinner"></div>
        <p style="font-size: 1.25rem; margin-top: 16px;">Loading game data...</p>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="container hidden">
        <!-- Header -->
        <div class="header">
            <h1 class="title">
                <span class="skull">💀</span>
                MAFIA MATRIX DEATH DETECTIVE SYSTEM
                <span class="skull">💀</span>
            </h1>
            
            <!-- Primary Stats -->
            <div class="stats-container">
                <div class="stat-box">
                    <div class="stat-number" style="color: #10b981;" id="aliveCount">0</div>
                    <div class="stat-label">Players Alive</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" style="color: #ef4444;" id="deadCount">0</div>
                    <div class="stat-label">Players Dead</div>
                </div>
                <div class="stat-box" id="newCountBox" style="display: none;">
                    <div class="stat-number" style="color: #eab308;" id="newCount">0</div>
                    <div class="stat-label">New This Scan</div>
                </div>
            </div>
            
            <!-- City Distribution -->
            <div class="city-stats" id="cityStats"></div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="switchTab('parse')">📥 Parse Data</button>
                <button class="tab-button" onclick="switchTab('manage')">👥 Manage Players</button>
                <button class="tab-button" onclick="switchTab('survivors')">💥 Survivor Data</button>
                <button class="tab-button" onclick="switchTab('funeral')">⚰️ Funeral Parlor</button>
                <button class="tab-button" onclick="switchTab('death')">💀 Death Detective</button>
                <button class="tab-button" onclick="switchTab('stats')">📊 Statistics</button>
            </div>

            <div class="tab-content">
                <!-- Parse Tab -->
                <div id="parseTab" class="tab-panel active">
                    <h2 style="font-size: 1.25rem; font-weight: bold; margin-bottom: 8px;">Parse Player Data</h2>
                    <div class="alert">
                        <p style="font-weight: bold;">🔍 Death Detective Active!</p>
                        <p>• Players missing from this scan will be marked as DEAD</p>
                        <p>• Anyone who has EVER been Hospital Director → Combat Medic</p>
                        <p>• New players will be flagged</p>
                        <p>• Full career history tracked for each player</p>
                        <p style="margin-top: 8px; font-weight: bold;">⚠️ VALID CITIES: Beirut, Chicago, Auckland</p>
                        <p style="font-size: 0.875rem; margin-top: 4px;">💡 Use "Fix CM Status" button in Manage tab if CMs aren't marked correctly</p>
                    </div>
                    
                    <p style="color: #9ca3af; margin-bottom: 16px;">Paste your player data below in the format: NAME [TAB/SPACES] OCCUPATION [TAB/SPACES] RANK [TAB/SPACES] CITY</p>
                    
                    <div class="button-group">
                        <button onclick="pasteFromClipboard('parseInput')" class="button button-secondary">📋 Paste from Clipboard</button>
                        <button onclick="clearInput('parseInput')" class="button button-secondary">Clear</button>
                        <button onclick="clearAllData()" class="button button-danger">🗑️ Clear All Data</button>
                    </div>
                    
                    <div class="input-group">
                        <textarea id="parseInput" class="textarea" 
                                  placeholder="NAME    OCCUPATION    RANK    CITY&#10;John    Police Officer    Detective    Chicago&#10;Jane    Hospital Director    Chief    Auckland"></textarea>
                    </div>
                    
                    <button onclick="parsePlayerData()" class="button button-primary" id="parseButton">
                        Parse & Detect Deaths
                    </button>
                    
                    <!-- Manual Add Player -->
                    <div style="margin-top: 32px; padding: 16px; background-color: #374151; border-radius: 4px;">
                        <h3 style="font-size: 1.125rem; font-weight: bold; margin-bottom: 12px;">Manually Add Player</h3>
                        <div class="manual-add-grid">
                            <input type="text" id="manualName" placeholder="Player Name" class="input">
                            <input type="text" id="manualOccupation" placeholder="Occupation" class="input">
                            <input type="text" id="manualRank" placeholder="Rank" class="input">
                            <select id="manualCity" class="select">
                                <option value="">Select City</option>
                                <option value="Beirut">Beirut</option>
                                <option value="Chicago">Chicago</option>
                                <option value="Auckland">Auckland</option>
                            </select>
                        </div>
                        <button onclick="addPlayerManually()" class="button button-primary">
                            ➕ Add Player
                        </button>
                    </div>
                </div>

                <!-- Manage Tab -->
                <div id="manageTab" class="tab-panel">
                    <div style="margin-bottom: 16px; padding: 12px; background-color: #374151; border-radius: 8px;">
                        <div style="display: flex; flex-wrap: wrap; gap: 16px; font-size: 0.875rem;">
                            <span>Total Alive: <strong style="color: #10b981;" id="totalAlive">0</strong></span>
                            <span>Opposition: <strong style="color: #ef4444;" id="totalOps">0</strong></span>
                            <span>Combat Medics (Ever HD): <strong style="color: #60a5fa;" id="totalCM">0</strong></span>
                            <span>Friendly: <strong style="color: #10b981;" id="totalFriendly">0</strong></span>
                            <span>New Players: <strong style="color: #eab308;" id="totalNew">0</strong></span>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <div style="display: flex; flex-wrap: wrap; gap: 16px; margin-bottom: 16px;">
                            <input type="text" id="searchQuery" placeholder="Search players..." class="input" style="flex: 1; min-width: 200px;" oninput="updatePlayerTable()">
                            <select id="filterCity" class="select" onchange="updatePlayerTable()">
                                <option value="">All Cities</option>
                                <option value="Beirut">Beirut</option>
                                <option value="Chicago">Chicago</option>
                                <option value="Auckland">Auckland</option>
                            </select>
                            <select id="filterStatus" class="select" onchange="updatePlayerTable()">
                                <option value="">All Living</option>
                                <option value="new">🆕 New</option>
                                <option value="ops">⚔️ Opposition</option>
                                <option value="cm">✓ Combat Medic (Ever HD)</option>
                                <option value="friendly">😊 Friendly</option>
                                <option value="dead">💀 Dead</option>
                            </select>
                            <button onclick="exportToCSV()" class="button button-primary">📥 Export CSV</button>
                            <button onclick="recalculateCMStatus()" class="button button-secondary" title="Recalculate Combat Medic status">❤️ Fix CM Status</button>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table class="table" id="playerTable">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>City</th>
                                    <th>Occupation</th>
                                    <th>Rank</th>
                                    <th>Notes</th>
                                    <th>💥</th>
                                    <th>🎯</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="playerTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Survivor Data Tab -->
                <div id="survivorsTab" class="tab-panel">
                    <h2 style="font-size: 1.25rem; font-weight: bold; margin-bottom: 8px;">Update Survivor Data</h2>
                    <div class="alert" style="background-color: #3b82f6;">
                        <p style="font-weight: bold;">💥 Whacks & MHS Survivor Parser</p>
                        <p>Format: <code>Name whacks [mhs] Name whacks [mhs]...</code></p>
                        <p>• First number = Whacks survived</p>
                        <p>• Second number (optional) = MHS survived</p>
                        <p style="margin-top: 8px;">Example: <code>Khayra 55 Sheogorath 196 2 Loki 66</code></p>
                    </div>
                    
                    <div class="button-group">
                        <button onclick="pasteFromClipboard('survivorInput')" class="button button-secondary">📋 Paste from Clipboard</button>
                        <button onclick="clearInput('survivorInput')" class="button button-secondary">Clear</button>
                    </div>
                    
                    <div class="input-group">
                        <textarea id="survivorInput" class="textarea" style="min-height: 120px;"
                                  placeholder="Khayra 55 Washed 102 MrPresident 147 Dodger 41 Sheogorath 196 2 Loki 66..."></textarea>
                    </div>
                    
                    <button onclick="parseSurvivorData()" class="button button-primary">
                        Update Survivor Data
                    </button>
                    
                    <!-- Top Survivors -->
                    <div style="margin-top: 32px;">
                        <h3 style="font-size: 1.125rem; font-weight: bold; margin-bottom: 16px;">🏆 Top Survivors</h3>
                        <div class="survivors-grid">
                            <div class="survivor-list">
                                <h4 style="font-weight: bold; margin-bottom: 8px; color: #eab308;">💥 Whacks Survived</h4>
                                <div id="topWhacksList"></div>
                            </div>
                            <div class="survivor-list">
                                <h4 style="font-weight: bold; margin-bottom: 8px; color: #eab308;">🎯 MHS Survived</h4>
                                <div id="topMHSList"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Funeral Parlor Tab -->
                <div id="funeralTab" class="tab-panel">
                    <h2 style="font-size: 1.25rem; font-weight: bold; margin-bottom: 8px;">Parse Funeral Parlor Data</h2>
                    <div class="alert alert-error">
                        <p style="font-weight: bold;">⚰️ Funeral Parlor Parser</p>
                        <p>• Paste funeral data to mark players as DEAD</p>
                        <p>• Captures last words if provided</p>
                        <p>• Tracks cause of death (Murdered/Suicide)</p>
                        <p>• Handles name changes</p>
                        <p style="margin-top: 8px; font-size: 0.75rem;">Format: NAME CITY OCCUPATION DATE TIME CAUSE</p>
                        <p style="font-size: 0.75rem;">Optional: NAME's last words: MESSAGE</p>
                    </div>
                    
                    <div class="button-group">
                        <button onclick="pasteFromClipboard('funeralInput')" class="button button-danger">📋 Paste Funeral Data</button>
                        <button onclick="clearInput('funeralInput')" class="button button-secondary">Clear</button>
                    </div>
                    
                    <div class="input-group">
                        <textarea id="funeralInput" class="textarea"
                                  placeholder="HmRCAucklandUnemployed6/27/2025 7:11:42 AMSuicide&#10;milkdudzAucklandLawyer6/27/2025 12:22:15 AMMurdered&#10;LarbeightAucklandGangster6/26/2025 5:09:41 PMMurdered&#10;Larbeight's last words: Oh noo I am so devastated..."></textarea>
                    </div>
                    
                    <button onclick="parseFuneralData()" class="button button-danger">
                        Process Funeral Data
                    </button>
                    
                    <!-- Recent Deaths with Last Words -->
                    <div style="margin-top: 32px;">
                        <h3 style="font-size: 1.125rem; font-weight: bold; margin-bottom: 16px;">Recent Deaths with Last Words</h3>
                        <div id="recentDeathsList"></div>
                    </div>
                </div>

                <!-- Death Detective Tab -->
                <div id="deathTab" class="tab-panel">
                    <h2 style="font-size: 1.25rem; font-weight: bold; margin-bottom: 16px;">Death Detective</h2>
                    
                    <div style="margin-bottom: 32px;">
                        <h3 style="font-size: 1.125rem; font-weight: bold; margin-bottom: 8px; color: #ef4444;">
                            Dead Players (<span id="deadPlayerCount">0</span>)
                        </h3>
                        <div id="deadPlayersList" class="death-list"></div>
                        <button onclick="removeAllDeadPlayers()" class="button button-danger" style="margin-top: 16px;">
                            Permanently Remove All Dead Players
                        </button>
                    </div>
                    
                    <div>
                        <h3 style="font-size: 1.125rem; font-weight: bold; margin-bottom: 8px; color: #eab308;">Possible Remakes</h3>
                        <p style="color: #9ca3af; margin-bottom: 16px;">These new players might be remakes of dead players:</p>
                        <div id="possibleRemakesList"></div>
                    </div>
                </div>

                <!-- Statistics Tab -->
                <div id="statsTab" class="tab-panel">
                    <h2 style="font-size: 1.25rem; font-weight: bold; margin-bottom: 16px;">City Statistics</h2>
                    <div id="cityStatsDetails" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification hidden"></div>

    <!-- Death Report Modal -->
    <div id="deathReportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="deathReportTitle" style="font-size: 1.5rem; font-weight: bold;">💀 DEATH REPORT 💀</h2>
                <button class="close-button" onclick="closeModal('deathReportModal')">×</button>
            </div>
            <div id="deathReportContent"></div>
            <button onclick="closeModal('deathReportModal')" class="button button-primary" style="width: 100%; margin-top: 16px;">
                Close Report
            </button>
        </div>
    </div>

    <!-- Player Profile Modal -->
    <div id="playerProfileModal" class="modal">
        <div class="modal-content" style="width: 800px;">
            <div class="modal-header">
                <h2 style="font-size: 1.5rem; font-weight: bold;">
                    👤 Player Profile: <span id="profilePlayerName"></span>
                </h2>
                <button class="close-button" onclick="closeModal('playerProfileModal')">×</button>
            </div>
            <div id="playerProfileContent"></div>
        </div>
    </div>

    <!-- Main Script -->
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB7b9Dw55ICNIhaeyjAvBHSQV071qAiJWc",
            authDomain: "mafia-matrix.firebaseapp.com",
            databaseURL: "https://mafia-matrix-default-rtdb.firebaseio.com",
            projectId: "mafia-matrix",
            storageBucket: "mafia-matrix.firebasestorage.app",
            messagingSenderId: "798418206931",
            appId: "1:798418206931:web:89b5c606ccb5443db61426"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // Global State
        let players = {};
        let lastScanPlayers = new Set();
        let currentGame = null;
        let isConnected = true;
        let sortField = 'name';
        let sortDirection = 'asc';
        
        // Initialize
        window.onload = function() {
            const savedGameCode = localStorage.getItem('mafiaMatrixGameCode');
            if (savedGameCode) {
                joinGame(savedGameCode);
            } else {
                showGameMenu();
            }
            
            // Monitor connection
            const connectedRef = database.ref('.info/connected');
            connectedRef.on('value', (snap) => {
                isConnected = snap.val() === true;
                updateConnectionStatus();
            });
            
            // Setup input listeners
            document.getElementById('joinGameCode').addEventListener('input', function(e) {
                e.target.value = e.target.value.toUpperCase();
                document.getElementById('joinButton').disabled = e.target.value.length < 4;
            });
        };
        
        // Game Management
        function showGameMenu() {
            document.getElementById('gameMenu').classList.remove('hidden');
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('statusBar').classList.add('hidden');
        }
        
        function showLoading() {
            document.getElementById('gameMenu').classList.add('hidden');
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }
        
        function showMainApp() {
            document.getElementById('gameMenu').classList.add('hidden');
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('statusBar').classList.remove('hidden');
        }
        
        function generateGameCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }
        
        function createNewGame() {
            const code = generateGameCode();
            const gameRef = database.ref(`games/${code}`);
            
            showLoading();
            
            gameRef.set({
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                lastUpdated: firebase.database.ServerValue.TIMESTAMP,
                players: {},
                settings: {
                    validCities: ['Beirut', 'Chicago', 'Auckland']
                }
            }).then(() => {
                joinGame(code);
                showNotification(`Created new game: ${code}`, 'success');
            });
        }
        
        function joinGame(code) {
            const upperCode = code.toUpperCase();
            const gameRef = database.ref(`games/${upperCode}`);
            
            showLoading();
            
            gameRef.once('value', (snapshot) => {
                if (snapshot.exists() || upperCode === currentGame) {
                    currentGame = upperCode;
                    localStorage.setItem('mafiaMatrixGameCode', upperCode);
                    document.getElementById('gameCodeDisplay').textContent = upperCode;
                    
                    // Setup listeners
                    setupGameListeners();
                    
                    showMainApp();
                    showNotification(`Joined game: ${upperCode}`, 'success');
                } else {
                    showNotification('Game not found', 'error');
                    showGameMenu();
                }
            });
        }
        
        function joinGameFromInput() {
            const code = document.getElementById('joinGameCode').value;
            if (code.length >= 4) {
                joinGame(code);
            }
        }
        
        function handleJoinKeyPress(event) {
            if (event.key === 'Enter' && document.getElementById('joinGameCode').value.length >= 4) {
                joinGameFromInput();
            }
        }
        
        function leaveGame() {
            if (confirm('Leave this game? You can rejoin with the same code.')) {
                localStorage.removeItem('mafiaMatrixGameCode');
                currentGame = null;
                players = {};
                lastScanPlayers = new Set();
                showGameMenu();
            }
        }
        
        function setupGameListeners() {
            if (!currentGame) return;
            
            const gameRef = database.ref(`games/${currentGame}`);
            
            // Listen to players
            const playersRef = gameRef.child('players');
            playersRef.on('value', (snapshot) => {
                const data = snapshot.val() || {};
                players = data;
                updateStats();
                updatePlayerTable();
                updateTopSurvivors();
                updateDeadPlayersList();
                updateRecentDeaths();
            });
            
            // Listen to last scan
            const lastScanRef = gameRef.child('lastScan');
            lastScanRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    lastScanPlayers = new Set(data);
                }
            });
            
            // Set online presence
            const presenceRef = gameRef.child('presence').push();
            presenceRef.set({
                joinedAt: firebase.database.ServerValue.TIMESTAMP,
                userAgent: navigator.userAgent
            });
            presenceRef.onDisconnect().remove();
        }
        
        function saveToFirebase(path, data) {
            if (!currentGame) return;
            
            const ref = database.ref(`games/${currentGame}/${path}`);
            ref.set(data).catch(err => {
                console.error('Firebase save error:', err);
                showNotification('Failed to save to cloud', 'error');
            });
        }
        
        // UI Functions
        function switchTab(tabName) {
            // Hide all panels
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            
            // Remove active from all buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected panel
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Mark button as active
            event.target.classList.add('active');
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification';
            
            if (type === 'success') {
                notification.style.backgroundColor = '#10b981';
            } else if (type === 'error') {
                notification.style.backgroundColor = '#ef4444';
            } else {
                notification.style.backgroundColor = '#3b82f6';
            }
            
            notification.classList.remove('hidden');
            
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 3000);
        }
        
        function updateConnectionStatus() {
            const indicator = document.getElementById('connectionIndicator');
            const text = document.getElementById('connectionText');
            
            if (isConnected) {
                indicator.className = 'status-indicator connected';
                text.textContent = 'Connected';
            } else {
                indicator.className = 'status-indicator disconnected';
                text.textContent = 'Offline';
            }
        }
        
        function updateStats() {
            const playerList = Object.values(players);
            const alive = playerList.filter(p => !p.isDead);
            const dead = playerList.filter(p => p.isDead);
            
            // Main stats
            document.getElementById('aliveCount').textContent = alive.length;
            document.getElementById('deadCount').textContent = dead.length;
            
            // New players
            const newPlayers = alive.filter(p => p.isNew);
            if (newPlayers.length > 0) {
                document.getElementById('newCountBox').style.display = 'block';
                document.getElementById('newCount').textContent = newPlayers.length;
            } else {
                document.getElementById('newCountBox').style.display = 'none';
            }
            
            // City stats
            const cities = {};
            const VALID_CITIES = ['Beirut', 'Chicago', 'Auckland'];
            
            alive.forEach(player => {
                if (VALID_CITIES.includes(player.currentCity)) {
                    if (!cities[player.currentCity]) {
                        cities[player.currentCity] = { total: 0, ops: 0, cm: 0 };
                    }
                    cities[player.currentCity].total++;
                    if (player.isOps) cities[player.currentCity].ops++;
                    if (player.wasHD) cities[player.currentCity].cm++;
                }
            });
            
            // Update city display
            const cityStatsDiv = document.getElementById('cityStats');
            cityStatsDiv.innerHTML = '<h3 style="font-size: 0.875rem; color: #9ca3af; text-align: center; margin-bottom: 12px; width: 100%;">City Distribution</h3>';
            
            Object.entries(cities).sort((a, b) => b[1].total - a[1].total).forEach(([city, data]) => {
                const cityBox = document.createElement('div');
                cityBox.className = 'city-box';
                cityBox.innerHTML = `
                    <div style="font-size: 1.25rem; font-weight: bold;">${data.total}</div>
                    <div style="font-size: 0.75rem; color: #9ca3af;">${city}</div>
                    ${(data.ops > 0 || data.cm > 0) ? `
                        <div style="font-size: 0.75rem; margin-top: 4px;">
                            ${data.ops > 0 ? `<span style="color: #ef4444; margin-right: 8px;">⚔️${data.ops}</span>` : ''}
                            ${data.cm > 0 ? `<span style="color: #60a5fa;">✓${data.cm}</span>` : ''}
                        </div>
                    ` : ''}
                `;
                cityStatsDiv.appendChild(cityBox);
            });
            
            // Update manage tab stats
            document.getElementById('totalAlive').textContent = alive.length;
            document.getElementById('totalOps').textContent = alive.filter(p => p.isOps).length;
            document.getElementById('totalCM').textContent = alive.filter(p => p.wasHD).length;
            document.getElementById('totalFriendly').textContent = alive.filter(p => p.isFriendly).length;
            document.getElementById('totalNew').textContent = newPlayers.length;
            
            // Update city stats details
            const cityStatsDetails = document.getElementById('cityStatsDetails');
            cityStatsDetails.innerHTML = '';
            Object.entries(cities).sort((a, b) => b[1].total - a[1].total).forEach(([city, data]) => {
                const cityDiv = document.createElement('div');
                cityDiv.style.backgroundColor = '#374151';
                cityDiv.style.padding = '16px';
                cityDiv.style.borderRadius = '4px';
                cityDiv.innerHTML = `
                    <h3 style="font-weight: bold; font-size: 1.125rem; margin-bottom: 8px;">${city}</h3>
                    <div style="font-size: 0.875rem;">
                        <div>Total: ${data.total} players</div>
                        ${data.ops > 0 ? `<div style="color: #ef4444;">Opposition: ${data.ops}</div>` : ''}
                        ${data.cm > 0 ? `<div style="color: #60a5fa;">Combat Medics: ${data.cm}</div>` : ''}
                    </div>
                `;
                cityStatsDetails.appendChild(cityDiv);
            });
        }
        
        // Player Data Parsing
        function parsePlayerData() {
            const rawData = document.getElementById('parseInput').value.trim();
            if (!rawData) return;
            
            const VALID_CITIES = ['Beirut', 'Chicago', 'Auckland'];
            const lines = rawData.split('\n');
            let startLine = 0;
            
            if (lines.length > 0 && lines[0].includes('NAME') && lines[0].includes('OCCUPATION')) {
                startLine = 1;
            }
            
            let processedLines = 0;
            let skippedLines = 0;
            let invalidCityCount = 0;
            const currentScanPlayers = new Set();
            const updatedPlayers = { ...players };
            const newPlayersThisScan = [];
            const diedPlayers = [];
            
            // First pass: Process all players from current scan
            for (let i = startLine; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) {
                    skippedLines++;
                    continue;
                }
                
                let parts = [];
                if (line.includes('\t')) {
                    parts = line.split('\t').map(p => p.trim()).filter(p => p);
                } else {
                    parts = line.split(/\s{2,}/).map(p => p.trim()).filter(p => p);
                    if (parts.length < 4) {
                        parts = line.split(/\s+/);
                    }
                }
                
                if (parts.length < 4) {
                    skippedLines++;
                    continue;
                }
                
                const [name, occupation, rank, city] = parts;
                
                if (!name || !occupation || !rank || !city) {
                    skippedLines++;
                    continue;
                }
                
                if (!VALID_CITIES.includes(city)) {
                    console.warn(`Invalid city detected: "${city}" for player ${name}`);
                    invalidCityCount++;
                    skippedLines++;
                    continue;
                }
                
                if (VALID_CITIES.includes(occupation) || VALID_CITIES.includes(rank)) {
                    console.warn(`City name found in wrong position for player ${name}`);
                    invalidCityCount++;
                    skippedLines++;
                    continue;
                }
                
                processedLines++;
                currentScanPlayers.add(name);
                
                const occupationLower = occupation.toLowerCase().trim();
                const isCurrentlyHD = (occupationLower.includes('hospital') && occupationLower.includes('director')) || 
                                     (occupationLower.includes('combat') && occupationLower.includes('medic'));
                
                if (!updatedPlayers[name]) {
                    // New player
                    updatedPlayers[name] = {
                        currentOccupation: occupation,
                        currentRank: rank,
                        currentCity: city,
                        firstSeen: new Date().toISOString(),
                        lastUpdated: new Date().toISOString(),
                        isNew: true,
                        notes: '',
                        isOps: false,
                        wasHD: isCurrentlyHD,
                        isCurrentlyHD: isCurrentlyHD,
                        isFriendly: false,
                        whacksSurvived: 0,
                        mhsSurvived: 0,
                        isDead: false,
                        careerHistory: [{
                            occupation: occupation,
                            rank: rank,
                            city: city,
                            startDate: new Date().toISOString(),
                            endDate: null,
                            isCurrent: true
                        }]
                    };
                    newPlayersThisScan.push(name);
                } else {
                    // Existing player
                    const player = updatedPlayers[name];
                    player.isDead = false;
                    player.deathDate = null;
                    player.isCurrentlyHD = isCurrentlyHD;
                    
                    // Check career history for ANY Hospital Director position
                    const hasBeenHD = player.careerHistory && player.careerHistory.some(career => {
                        const careerLower = (career.occupation || '').toLowerCase().trim();
                        return (careerLower.includes('hospital') && careerLower.includes('director')) || 
                               (careerLower.includes('combat') && careerLower.includes('medic'));
                    });
                    
                    if (isCurrentlyHD || hasBeenHD) {
                        player.wasHD = true;
                    }
                    
                    // Check for career changes
                    const hasCareerChange = player.currentOccupation !== occupation || 
                                           player.currentRank !== rank || 
                                           player.currentCity !== city;
                    
                    if (hasCareerChange) {
                        if (player.careerHistory && player.careerHistory.length > 0) {
                            const currentCareer = player.careerHistory.find(c => c.isCurrent);
                            if (currentCareer) {
                                currentCareer.endDate = new Date().toISOString();
                                currentCareer.isCurrent = false;
                            }
                        }
                        
                        if (!player.careerHistory) {
                            player.careerHistory = [];
                        }
                        
                        player.careerHistory.push({
                            occupation: occupation,
                            rank: rank,
                            city: city,
                            startDate: new Date().toISOString(),
                            endDate: null,
                            isCurrent: true
                        });
                        
                        player.currentOccupation = occupation;
                        player.currentRank = rank;
                        player.currentCity = city;
                    }
                    
                    player.lastUpdated = new Date().toISOString();
                    player.isNew = false;
                }
            }
            
            // Second pass: Mark missing players as dead
            if (lastScanPlayers.size > 0) {
                for (const playerName of lastScanPlayers) {
                    if (!currentScanPlayers.has(playerName) && updatedPlayers[playerName] && !updatedPlayers[playerName].isDead) {
                        const player = updatedPlayers[playerName];
                        player.isDead = true;
                        player.deathDate = new Date().toISOString();
                        player.isCurrentlyHD = false;
                        
                        if (player.careerHistory && player.careerHistory.length > 0) {
                            const currentCareer = player.careerHistory.find(c => c.isCurrent);
                            if (currentCareer) {
                                currentCareer.endDate = player.deathDate;
                                currentCareer.isCurrent = false;
                            }
                        }
                        
                        diedPlayers.push(playerName);
                    }
                }
            }
            
            // Save to Firebase
            saveToFirebase('players', updatedPlayers);
            saveToFirebase('lastScan', [...currentScanPlayers]);
            saveToFirebase('lastUpdated', firebase.database.ServerValue.TIMESTAMP);
            
            lastScanPlayers = currentScanPlayers;
            
            // Show death report if needed
            if (diedPlayers.length > 0 || newPlayersThisScan.length > 0) {
                showDeathReport(diedPlayers, newPlayersThisScan);
            }
            
            // Summary
            const alivePlayers = Object.entries(updatedPlayers).filter(([_, p]) => !p.isDead).length;
            const combatMedics = Object.entries(updatedPlayers).filter(([_, p]) => !p.isDead && p.wasHD).length;
            
            let summary = `Parsing complete!\nProcessed: ${processedLines} lines\nSkipped: ${skippedLines} lines`;
            if (invalidCityCount > 0) {
                summary += `\nInvalid cities: ${invalidCityCount} (check data format!)`;
            }
            summary += `\nAlive players: ${alivePlayers}\nCombat Medics (Ever HD): ${combatMedics}\nDied this scan: ${diedPlayers.length}\nNew players: ${newPlayersThisScan.length}`;
            
            showNotification(summary, 'success');
            document.getElementById('parseInput').value = '';
        }
        
        function parseSurvivorData() {
            const rawData = document.getElementById('survivorInput').value.trim();
            if (!rawData) return;
            
            const tokens = rawData.split(/\s+/);
            const updatedPlayers = { ...players };
            let updatedCount = 0;
            let notFoundCount = 0;
            
            let i = 0;
            while (i < tokens.length) {
                const name = tokens[i];
                
                if (!isNaN(name)) {
                    i++;
                    continue;
                }
                
                let whacks = 0;
                let mhs = 0;
                
                if (i + 1 < tokens.length && !isNaN(tokens[i + 1])) {
                    whacks = parseInt(tokens[i + 1]);
                    
                    if (i + 2 < tokens.length && !isNaN(tokens[i + 2])) {
                        mhs = parseInt(tokens[i + 2]);
                        i += 3;
                    } else {
                        i += 2;
                    }
                } else {
                    i++;
                    continue;
                }
                
                if (updatedPlayers[name]) {
                    updatedPlayers[name].whacksSurvived = whacks;
                    updatedPlayers[name].mhsSurvived = mhs;
                    updatedCount++;
                } else {
                    notFoundCount++;
                    console.warn(`Player not found: ${name}`);
                }
            }
            
            saveToFirebase('players', updatedPlayers);
            document.getElementById('survivorInput').value = '';
            
            const summary = `Survivor data updated!\nUpdated: ${updatedCount} players\nNot found: ${notFoundCount} players`;
            showNotification(summary, 'success');
        }
        
        function parseFuneralData() {
            const rawData = document.getElementById('funeralInput').value.trim();
            if (!rawData) return;
            
            const lines = rawData.split('\n');
            const updatedPlayers = { ...players };
            let processedDeaths = 0;
            let notFoundCount = 0;
            let nameChanges = 0;
            const deathDetails = [];
            const VALID_CITIES = ['Beirut', 'Chicago', 'Auckland'];
            
            let i = 0;
            while (i < lines.length) {
                const line = lines[i].trim();
                if (!line) {
                    i++;
                    continue;
                }
                
                if (line.includes("'s last words:")) {
                    i++;
                    continue;
                }
                
                const dateTimeMatch = line.match(/(\d{1,2}\/\d{1,2}\/\d{4}\s+\d{1,2}:\d{2}:\d{2}\s+[AP]M)/);
                
                if (!dateTimeMatch) {
                    console.warn(`Could not find date/time in funeral line: ${line}`);
                    i++;
                    continue;
                }
                
                const dateTime = dateTimeMatch[1];
                const dateTimeIndex = line.indexOf(dateTime);
                const beforeDateTime = line.substring(0, dateTimeIndex);
                const cause = line.substring(dateTimeIndex + dateTime.length).trim();
                
                let name = '';
                let city = '';
                let occupation = '';
                
                for (const validCity of VALID_CITIES) {
                    const cityIndex = beforeDateTime.indexOf(validCity);
                    if (cityIndex !== -1) {
                        city = validCity;
                        name = beforeDateTime.substring(0, cityIndex);
                        occupation = beforeDateTime.substring(cityIndex + validCity.length);
                        break;
                    }
                }
                
                if (!city) {
                    console.warn(`Could not find valid city in funeral line: ${line}`);
                    i++;
                    continue;
                }
                
                name = name.replace(/\*\*/g, '').trim();
                occupation = occupation.trim();
                
                let lastWords = '';
                if (i + 1 < lines.length) {
                    const nextLine = lines[i + 1];
                    if (nextLine.includes(`${name}'s last words:`) || 
                        (name.includes('**') && nextLine.includes(`${name.replace(/\*\*/g, '')}'s last words:`))) {
                        lastWords = nextLine.substring(nextLine.indexOf(':') + 1).trim();
                        i++;
                    }
                }
                
                if (cause.includes('Name Change')) {
                    nameChanges++;
                    deathDetails.push({
                        name,
                        city,
                        occupation,
                        dateTime,
                        cause: 'Name Change',
                        lastWords
                    });
                } else {
                    if (updatedPlayers[name]) {
                        const player = updatedPlayers[name];
                        player.isDead = true;
                        player.deathDate = new Date(dateTime).toISOString();
                        player.causeOfDeath = cause;
                        player.lastWords = lastWords;
                        player.isCurrentlyHD = false;
                        
                        const occupationLower = (occupation || '').toLowerCase().trim();
                        const wasHDAtDeath = (occupationLower.includes('hospital') && occupationLower.includes('director')) || 
                                            (occupationLower.includes('combat') && occupationLower.includes('medic'));
                        if (wasHDAtDeath) {
                            player.wasHD = true;
                        }
                        
                        if (player.careerHistory && player.careerHistory.length > 0) {
                            const currentCareer = player.careerHistory.find(c => c.isCurrent);
                            if (currentCareer) {
                                currentCareer.endDate = player.deathDate;
                                currentCareer.isCurrent = false;
                            }
                        }
                        
                        processedDeaths++;
                        deathDetails.push({
                            name,
                            city,
                            occupation,
                            dateTime,
                            cause,
                            lastWords,
                            found: true
                        });
                    } else {
                        notFoundCount++;
                        deathDetails.push({
                            name,
                            city,
                            occupation,
                            dateTime,
                            cause,
                            lastWords,
                            found: false
                        });
                    }
                }
                
                i++;
            }
            
            saveToFirebase('players', updatedPlayers);
            document.getElementById('funeralInput').value = '';
            
            // Show funeral report
            showFuneralReport(deathDetails);
            
            const summary = `Funeral parsing complete!\nProcessed deaths: ${processedDeaths}\nNot found: ${notFoundCount}\nName changes: ${nameChanges}`;
            showNotification(summary, 'success');
        }
        
        // Helper Functions
        function addPlayerManually() {
            const name = document.getElementById('manualName').value.trim();
            const occupation = document.getElementById('manualOccupation').value.trim();
            const rank = document.getElementById('manualRank').value.trim();
            const city = document.getElementById('manualCity').value;
            
            if (name && occupation && rank && city) {
                const updatedPlayers = { ...players };
                const occupationLower = occupation.toLowerCase().trim();
                const isCurrentlyHD = (occupationLower.includes('hospital') && occupationLower.includes('director')) || 
                                    (occupationLower.includes('combat') && occupationLower.includes('medic'));
                
                updatedPlayers[name] = {
                    currentOccupation: occupation,
                    currentRank: rank,
                    currentCity: city,
                    firstSeen: new Date().toISOString(),
                    lastUpdated: new Date().toISOString(),
                    isNew: true,
                    notes: '',
                    isOps: false,
                    wasHD: isCurrentlyHD,
                    isCurrentlyHD: isCurrentlyHD,
                    isFriendly: false,
                    whacksSurvived: 0,
                    mhsSurvived: 0,
                    isDead: false,
                    careerHistory: [{
                        occupation: occupation,
                        rank: rank,
                        city: city,
                        startDate: new Date().toISOString(),
                        endDate: null,
                        isCurrent: true
                    }]
                };
                
                saveToFirebase('players', updatedPlayers);
                
                // Clear inputs
                document.getElementById('manualName').value = '';
                document.getElementById('manualOccupation').value = '';
                document.getElementById('manualRank').value = '';
                document.getElementById('manualCity').value = '';
                
                showNotification(`Added ${name}`, 'success');
            } else {
                showNotification('Please fill in all fields', 'error');
            }
        }
        
        function recalculateCMStatus() {
            const updatedPlayers = { ...players };
            let updateCount = 0;
            
            Object.entries(updatedPlayers).forEach(([name, player]) => {
                const wasHDBefore = player.wasHD;
                
                const currentOccupationLower = (player.currentOccupation || '').toLowerCase().trim();
                const isCurrentlyHD = (currentOccupationLower.includes('hospital') && currentOccupationLower.includes('director')) || 
                                     (currentOccupationLower.includes('combat') && currentOccupationLower.includes('medic'));
                
                const hasBeenHD = player.careerHistory && player.careerHistory.some(career => {
                    const careerLower = (career.occupation || '').toLowerCase().trim();
                    return (careerLower.includes('hospital') && careerLower.includes('director')) || 
                           (careerLower.includes('combat') && careerLower.includes('medic'));
                });
                
                player.wasHD = isCurrentlyHD || hasBeenHD;
                
                if (player.wasHD !== wasHDBefore) {
                    updateCount++;
                }
            });
            
            saveToFirebase('players', updatedPlayers);
            showNotification(`Recalculated CM status. Updated ${updateCount} players.`, 'success');
        }
        
        function exportToCSV() {
            const headers = ['Name', 'Current_Occupation', 'Current_Rank', 'Current_City', 'First_Seen', 'Last_Updated', 'Is_New', 'Notes', 'Is_Ops', 'Was_HD', 'Is_Currently_HD', 'Is_Friendly', 'Whacks_Survived', 'MHS_Survived', 'Is_Dead', 'Death_Date', 'Cause_Of_Death', 'Last_Words', 'Career_History'];
            
            const rows = Object.entries(players).map(([name, player]) => {
                const careerHistoryStr = (player.careerHistory || []).map(h => 
                    `${h.occupation}|${h.rank}|${h.city}|${h.startDate}|${h.endDate || 'current'}`
                ).join(';');
                
                return [
                    name,
                    player.currentOccupation,
                    player.currentRank,
                    player.currentCity,
                    player.firstSeen,
                    player.lastUpdated,
                    player.isNew ? 'Yes' : 'No',
                    player.notes,
                    player.isOps ? 'Yes' : 'No',
                    player.wasHD ? 'Yes' : 'No',
                    player.isCurrentlyHD ? 'Yes' : 'No',
                    player.isFriendly ? 'Yes' : 'No',
                    player.whacksSurvived || 0,
                    player.mhsSurvived || 0,
                    player.isDead ? 'Yes' : 'No',
                    player.deathDate || '',
                    player.causeOfDeath || '',
                    player.lastWords || '',
                    careerHistoryStr
                ];
            });
            
            const csv = [headers, ...rows].map(row => 
                row.map(cell => `"${cell.toString().replace(/"/g, '""')}"`).join(',')
            ).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mafia_matrix_${currentGame}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('Data exported successfully', 'success');
        }
        
        function pasteFromClipboard(inputId) {
            navigator.clipboard.readText().then(text => {
                document.getElementById(inputId).value = text;
                showNotification('Pasted from clipboard', 'success');
            }).catch(err => {
                showNotification('Failed to read clipboard', 'error');
            });
        }
        
        function clearInput(inputId) {
            document.getElementById(inputId).value = '';
        }
        
        function clearAllData() {
            if (confirm('Are you sure you want to clear ALL player data? This cannot be undone!')) {
                saveToFirebase('players', {});
                saveToFirebase('lastScan', []);
                lastScanPlayers = new Set();
                showNotification('All data cleared', 'success');
            }
        }
        
        function removeAllDeadPlayers() {
            const updatedPlayers = { ...players };
            let removedCount = 0;
            
            Object.entries(players).forEach(([name, player]) => {
                if (player.isDead) {
                    delete updatedPlayers[name];
                    removedCount++;
                }
            });
            
            saveToFirebase('players', updatedPlayers);
            showNotification(`Permanently removed ${removedCount} dead players`, 'success');
        }
        
        // Player Table Functions
        function updatePlayerTable() {
            const tbody = document.getElementById('playerTableBody');
            tbody.innerHTML = '';
            
            const searchQuery = document.getElementById('searchQuery').value.toLowerCase();
            const filterCity = document.getElementById('filterCity').value;
            const filterStatus = document.getElementById('filterStatus').value;
            
            const filteredPlayers = Object.entries(players).filter(([name, player]) => {
                if (filterStatus !== 'dead' && player.isDead) {
                    return false;
                }
                
                if (searchQuery) {
                    if (!name.toLowerCase().includes(searchQuery) &&
                        !player.currentCity.toLowerCase().includes(searchQuery) &&
                        !player.currentOccupation.toLowerCase().includes(searchQuery)) {
                        return false;
                    }
                }
                
                if (filterCity && player.currentCity !== filterCity) {
                    return false;
                }
                
                if (filterStatus) {
                    switch (filterStatus) {
                        case 'new': return player.isNew;
                        case 'ops': return player.isOps;
                        case 'cm': return player.wasHD;
                        case 'friendly': return player.isFriendly;
                        case 'dead': return player.isDead;
                        default: return true;
                    }
                }
                
                return true;
            });
            
            filteredPlayers.forEach(([name, player]) => {
                const row = document.createElement('tr');
                if (player.isDead) row.className = 'dead';
                
                row.innerHTML = `
                    <td style="padding: 8px;">
                        <a href="#" onclick="openPlayerProfile('${name}'); return false;" class="player-link">
                            ${name}
                        </a>
                        ${player.isDead ? '<span style="color: #ef4444; margin-left: 4px;">💀</span>' : ''}
                    </td>
                    <td style="padding: 8px;">${player.currentCity}</td>
                    <td style="padding: 8px;">${player.currentOccupation}</td>
                    <td style="padding: 8px;">${player.currentRank}</td>
                    <td style="padding: 8px;">
                        <input type="text" value="${player.notes || ''}" 
                               onchange="updatePlayerNotes('${name}', this.value)"
                               class="input" style="width: 100%; font-size: 0.875rem;">
                    </td>
                    <td style="padding: 8px; text-align: center;">${player.whacksSurvived || 0}</td>
                    <td style="padding: 8px; text-align: center;">${player.mhsSurvived || 0}</td>
                    <td style="padding: 8px;">
                        <div style="display: flex; gap: 4px; flex-wrap: wrap;">
                            ${player.isNew ? '<span class="status-badge" style="color: #10b981;">🆕NEW</span>' : ''}
                            ${player.isOps ? '<span class="status-badge" style="color: #ef4444;">⚔️OPS</span>' : ''}
                            ${player.wasHD ? '<span class="status-badge" style="color: #60a5fa;">✓CM</span>' : ''}
                            ${player.isFriendly ? '<span class="status-badge" style="color: #10b981;">😊FRIEND</span>' : ''}
                            ${player.isDead ? '<span class="status-badge" style="color: #6b7280;">💀DEAD</span>' : ''}
                        </div>
                    </td>
                    <td style="padding: 8px;">
                        <div style="display: flex; gap: 4px;">
                            <button onclick="togglePlayerStatus('${name}', 'isOps')" 
                                    class="icon-button ${player.isOps ? 'button-danger' : 'button-secondary'}"
                                    title="Toggle Opposition">⚔️</button>
                            <button onclick="togglePlayerStatus('${name}', 'wasHD')" 
                                    class="icon-button ${player.wasHD ? 'button-primary' : 'button-secondary'}"
                                    style="${player.wasHD ? 'background-color: #3b82f6;' : ''}"
                                    title="Toggle Combat Medic">❤️</button>
                            <button onclick="togglePlayerStatus('${name}', 'isFriendly')" 
                                    class="icon-button ${player.isFriendly ? 'button-primary' : 'button-secondary'}"
                                    title="Toggle Friendly">👥</button>
                            <button onclick="deletePlayer('${name}')" 
                                    class="icon-button button-danger"
                                    title="Delete Player">🗑️</button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            if (filteredPlayers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 32px; color: #9ca3af;">No players found matching your filters</td></tr>';
            }
        }
        
        function togglePlayerStatus(playerName, statusField) {
            const updatedPlayers = {
                ...players,
                [playerName]: {
                    ...players[playerName],
                    [statusField]: !players[playerName][statusField]
                }
            };
            saveToFirebase('players', updatedPlayers);
        }
        
        function updatePlayerNotes(playerName, notes) {
            const updatedPlayers = {
                ...players,
                [playerName]: {
                    ...players[playerName],
                    notes: notes
                }
            };
            saveToFirebase('players', updatedPlayers);
        }
        
        function deletePlayer(playerName) {
            if (confirm(`Are you sure you want to delete ${playerName}?`)) {
                const updatedPlayers = { ...players };
                delete updatedPlayers[playerName];
                saveToFirebase('players', updatedPlayers);
                showNotification(`Deleted ${playerName}`, 'success');
            }
        }
        
        // Modal Functions
        function showDeathReport(diedPlayers, newPlayers) {
            const modal = document.getElementById('deathReportModal');
            const content = document.getElementById('deathReportContent');
            
            content.innerHTML = '';
            
            if (diedPlayers.length > 0) {
                content.innerHTML += `
                    <div style="margin-bottom: 24px;">
                        <h3 style="font-size: 1.25rem; font-weight: bold; margin-bottom: 8px; color: #ef4444;">
                            Players Who Died (${diedPlayers.length}):
                        </h3>
                        <div style="background-color: #374151; border-radius: 4px; padding: 16px;">
                            ${diedPlayers.map(name => `
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                    <span style="color: #ef4444;">💀</span>
                                    <span>${name}</span>
                                    ${players[name] ? `
                                        <span style="color: #9ca3af; font-size: 0.875rem;">
                                            - was ${players[name].currentOccupation} in ${players[name].currentCity}
                                        </span>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            if (newPlayers.length > 0) {
                content.innerHTML += `
                    <div>
                        <h3 style="font-size: 1.25rem; font-weight: bold; margin-bottom: 8px; color: #10b981;">
                            New Players (${newPlayers.length}):
                        </h3>
                        <div style="background-color: #374151; border-radius: 4px; padding: 16px;">
                            ${newPlayers.map(name => `
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                    <span style="color: #10b981;">➕</span>
                                    <span>${name}</span>
                                    ${players[name] ? `
                                        <span style="color: #9ca3af; font-size: 0.875rem;">
                                            - ${players[name].currentOccupation} in ${players[name].currentCity}
                                        </span>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            modal.classList.add('active');
        }
        
        function showFuneralReport(deathDetails) {
            const modal = document.getElementById('deathReportModal');
            const title = document.getElementById('deathReportTitle');
            const content = document.getElementById('deathReportContent');
            
            title.textContent = '⚰️ FUNERAL REPORT ⚰️';
            content.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    ${deathDetails.map(death => `
                        <div style="padding: 12px; border-radius: 4px; ${
                            death.cause === 'Name Change' ? 'background-color: #a16207;' : 
                            death.found ? 'background-color: #374151;' : 'background-color: #7f1d1d;'
                        }">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    ${death.cause === 'Name Change' ? '<span style="color: #fbbf24;">🔄</span>' :
                                      death.cause === 'Murdered' ? '<span style="color: #ef4444;">🗡️</span>' :
                                      '<span style="color: #9ca3af;">💊</span>'}
                                    <span style="font-weight: bold; ${!death.found ? 'color: #fca5a5;' : ''}">
                                        ${death.name} ${!death.found ? '(NOT FOUND)' : ''}
                                    </span>
                                    <span style="font-size: 0.875rem; color: #9ca3af;">
                                        - ${death.occupation} in ${death.city}
                                    </span>
                                </div>
                                <span style="font-size: 0.875rem; color: #9ca3af;">
                                    ${death.cause}
                                </span>
                            </div>
                            ${death.lastWords ? `
                                <p style="margin-top: 8px; font-size: 0.875rem; font-style: italic; color: #d1d5db; padding-left: 32px;">
                                    Last words: "${death.lastWords}"
                                </p>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
            
            modal.classList.add('active');
        }
        
        function openPlayerProfile(playerName) {
            const player = players[playerName];
            if (!player) return;
            
            const modal = document.getElementById('playerProfileModal');
            document.getElementById('profilePlayerName').textContent = playerName;
            const content = document.getElementById('playerProfileContent');
            
            const careerHistory = player.careerHistory || [];
            
            content.innerHTML = `
                <!-- Current Status -->
                <div style="background-color: #374151; border-radius: 4px; padding: 16px; margin-bottom: 16px;">
                    <h3 style="font-weight: bold; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                        📈 Current Status
                    </h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <p><span style="color: #9ca3af;">Occupation:</span> ${player.currentOccupation}</p>
                            <p><span style="color: #9ca3af;">Rank:</span> ${player.currentRank}</p>
                            <p style="display: flex; align-items: center; gap: 8px;">
                                <span style="color: #9ca3af;">City:</span> 
                                <select onchange="updatePlayerCity('${playerName}', this.value)" 
                                        class="select" style="font-size: 0.875rem;">
                                    <option value="Beirut" ${player.currentCity === 'Beirut' ? 'selected' : ''}>Beirut</option>
                                    <option value="Chicago" ${player.currentCity === 'Chicago' ? 'selected' : ''}>Chicago</option>
                                    <option value="Auckland" ${player.currentCity === 'Auckland' ? 'selected' : ''}>Auckland</option>
                                </select>
                            </p>
                            <p><span style="color: #9ca3af;">Status:</span> ${player.isDead ? '💀 Dead' : '✓ Alive'}</p>
                        </div>
                        <div>
                            <p><span style="color: #9ca3af;">First Seen:</span> ${formatDate(player.firstSeen)}</p>
                            <p><span style="color: #9ca3af;">Last Updated:</span> ${formatDate(player.lastUpdated)}</p>
                            ${player.deathDate ? `
                                <p><span style="color: #9ca3af;">Death Date:</span> ${formatDate(player.deathDate)}</p>
                                ${player.causeOfDeath ? `<p><span style="color: #9ca3af;">Cause:</span> ${player.causeOfDeath}</p>` : ''}
                            ` : ''}
                        </div>
                    </div>
                    
                    <!-- Combat Stats -->
                    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #4b5563;">
                        <h4 style="font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                            🎯 Combat Statistics
                        </h4>
                        <div class="combat-stats-grid">
                            <div class="combat-stat-box">
                                <p class="combat-stat-number">${player.whacksSurvived || 0}</p>
                                <p class="combat-stat-label">Whacks Survived</p>
                                <div class="combat-stat-buttons">
                                    <button onclick="updatePlayerCombatStats('${playerName}', 'whacksSurvived', ${Math.max(0, (player.whacksSurvived || 0) - 1)})"
                                            class="icon-button button-danger" title="Decrease">−</button>
                                    <button onclick="updatePlayerCombatStats('${playerName}', 'whacksSurvived', ${(player.whacksSurvived || 0) + 1})"
                                            class="icon-button button-primary" title="Increase">+</button>
                                </div>
                            </div>
                            <div class="combat-stat-box">
                                <p class="combat-stat-number">${player.mhsSurvived || 0}</p>
                                <p class="combat-stat-label">MHS Survived</p>
                                <div class="combat-stat-buttons">
                                    <button onclick="updatePlayerCombatStats('${playerName}', 'mhsSurvived', ${Math.max(0, (player.mhsSurvived || 0) - 1)})"
                                            class="icon-button button-danger" title="Decrease">−</button>
                                    <button onclick="updatePlayerCombatStats('${playerName}', 'mhsSurvived', ${(player.mhsSurvived || 0) + 1})"
                                            class="icon-button button-primary" title="Increase">+</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Status Badges -->
                    <div style="display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap;">
                        ${player.isNew ? '<span style="padding: 4px 8px; background-color: #047857; border-radius: 4px; font-size: 0.875rem;">🆕 New</span>' : ''}
                        ${player.isOps ? '<span style="padding: 4px 8px; background-color: #b91c1c; border-radius: 4px; font-size: 0.875rem;">⚔️ Opposition</span>' : ''}
                        ${player.wasHD ? '<span style="padding: 4px 8px; background-color: #1e40af; border-radius: 4px; font-size: 0.875rem;">✓ Combat Medic (Ever HD)</span>' : ''}
                        ${player.isFriendly ? '<span style="padding: 4px 8px; background-color: #059669; border-radius: 4px; font-size: 0.875rem;">😊 Friendly</span>' : ''}
                    </div>
                </div>
                
                ${player.isDead && player.lastWords ? `
                    <!-- Last Words -->
                    <div style="background-color: #7f1d1d; border-radius: 4px; padding: 16px; margin-bottom: 16px;">
                        <h3 style="font-weight: bold; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                            ⚰️ Last Words
                        </h3>
                        <p style="font-style: italic; color: #d1d5db;">"${player.lastWords}"</p>
                    </div>
                ` : ''}
                
                <!-- Career History -->
                <div style="background-color: #374151; border-radius: 4px; padding: 16px; margin-bottom: 16px;">
                    <h3 style="font-weight: bold; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                        📜 Career History (${careerHistory.length} positions)
                    </h3>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        ${careerHistory.slice().reverse().map((career, idx) => `
                            <div class="career-item ${career.isCurrent ? 'current' : ''}">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div>
                                        <p style="font-weight: 600;">
                                            ${career.occupation} - ${career.rank}
                                        </p>
                                        <p style="color: #9ca3af;">📍 ${career.city}</p>
                                    </div>
                                    <div style="text-align: right; font-size: 0.875rem;">
                                        <p style="color: #9ca3af;">
                                            📅 ${formatDate(career.startDate)} - ${formatDate(career.endDate)}
                                        </p>
                                        <p style="color: #6b7280;">
                                            Duration: ${calculateDuration(career.startDate, career.endDate)}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <!-- Notes Section -->
                <div style="background-color: #374151; border-radius: 4px; padding: 16px;">
                    <h3 style="font-weight: bold; margin-bottom: 8px;">Notes</h3>
                    <textarea onchange="updatePlayerNotes('${playerName}', this.value)"
                              style="width: 100%; min-height: 80px; background-color: #1f2937; border: 1px solid #4b5563; border-radius: 4px; padding: 8px; color: white; font-size: 0.875rem;"
                              placeholder="Add notes about this player...">${player.notes || ''}</textarea>
                </div>
            `;
            
            modal.classList.add('active');
        }
        
        function updatePlayerCity(playerName, city) {
            const updatedPlayers = {
                ...players,
                [playerName]: {
                    ...players[playerName],
                    currentCity: city
                }
            };
            saveToFirebase('players', updatedPlayers);
        }
        
        function updatePlayerCombatStats(playerName, field, value) {
            const updatedPlayers = {
                ...players,
                [playerName]: {
                    ...players[playerName],
                    [field]: value
                }
            };
            saveToFirebase('players', updatedPlayers);
            
            // Update the display
            openPlayerProfile(playerName);
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        // Utility Functions
        function formatDate(dateStr) {
            if (!dateStr) return 'Current';
            const date = new Date(dateStr);
            return date.toLocaleDateString();
        }
        
        function calculateDuration(startDate, endDate) {
            const start = new Date(startDate);
            const end = endDate ? new Date(endDate) : new Date();
            const days = Math.floor((end - start) / (1000 * 60 * 60 * 24));
            
            if (days < 1) return 'Less than a day';
            if (days === 1) return '1 day';
            if (days < 30) return `${days} days`;
            if (days < 365) return `${Math.floor(days / 30)} months`;
            return `${Math.floor(days / 365)} years`;
        }
        
        // Update Functions
        function updateTopSurvivors() {
            const whacksList = document.getElementById('topWhacksList');
            const mhsList = document.getElementById('topMHSList');
            
            // Top Whacks
            const topWhacks = Object.entries(players)
                .filter(([_, p]) => !p.isDead && p.whacksSurvived > 0)
                .sort(([,a], [,b]) => b.whacksSurvived - a.whacksSurvived)
                .slice(0, 10);
            
            whacksList.innerHTML = topWhacks.map(([name, player], idx) => `
                <div class="survivor-item">
                    <span style="display: flex; align-items: center; gap: 8px;">
                        <span style="color: #9ca3af;">${idx + 1}.</span>
                        <a href="#" onclick="openPlayerProfile('${name}'); return false;" class="player-link">
                            ${name}
                        </a>
                    </span>
                    <span style="font-weight: bold;">${player.whacksSurvived}</span>
                </div>
            `).join('');
            
            // Top MHS
            const topMHS = Object.entries(players)
                .filter(([_, p]) => !p.isDead && p.mhsSurvived > 0)
                .sort(([,a], [,b]) => b.mhsSurvived - a.mhsSurvived)
                .slice(0, 10);
            
            mhsList.innerHTML = topMHS.map(([name, player], idx) => `
                <div class="survivor-item">
                    <span style="display: flex; align-items: center; gap: 8px;">
                        <span style="color: #9ca3af;">${idx + 1}.</span>
                        <a href="#" onclick="openPlayerProfile('${name}'); return false;" class="player-link">
                            ${name}
                        </a>
                    </span>
                    <span style="font-weight: bold;">${player.mhsSurvived}</span>
                </div>
            `).join('');
        }
        
        function updateDeadPlayersList() {
            const deadList = document.getElementById('deadPlayersList');
            const deadPlayers = Object.entries(players).filter(([_, p]) => p.isDead);
            
            document.getElementById('deadPlayerCount').textContent = deadPlayers.length;
            
            if (deadPlayers.length > 0) {
                deadList.innerHTML = deadPlayers.map(([name, player]) => `
                    <div class="death-item">
                        <span style="color: #ef4444;">💀</span>
                        <a href="#" onclick="openPlayerProfile('${name}'); return false;" class="player-link">
                            ${name}
                        </a>
                        <span style="color: #9ca3af; font-size: 0.875rem;">
                            - was ${player.currentOccupation} in ${player.currentCity}
                        </span>
                        <span style="color: #6b7280; font-size: 0.875rem; margin-left: auto;">
                            ${player.deathDate ? new Date(player.deathDate).toLocaleDateString() : ''}
                        </span>
                    </div>
                `).join('');
            } else {
                deadList.innerHTML = '<p style="color: #9ca3af;">No dead players detected yet.</p>';
            }
            
            // Update possible remakes
            updatePossibleRemakes();
        }
        
        function updatePossibleRemakes() {
            const remakesList = document.getElementById('possibleRemakesList');
            const remakes = checkForRemakes();
            
            if (remakes.length > 0) {
                remakesList.innerHTML = remakes.slice(0, 10).map(match => `
                    <div style="background-color: #374151; border-radius: 4px; padding: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <a href="#" onclick="openPlayerProfile('${match.dead}'); return false;" 
                               style="color: #ef4444;">
                                ${match.dead}
                            </a>
                            <span style="margin: 0 8px;">→</span>
                            <a href="#" onclick="openPlayerProfile('${match.new}'); return false;" 
                               style="color: #10b981;">
                                ${match.new}
                            </a>
                            <span style="color: #9ca3af; margin-left: 8px;">in ${match.city}</span>
                        </div>
                        <div style="font-size: 0.875rem; color: #9ca3af;">
                            ${Math.round(match.similarity * 100)}% match
                        </div>
                    </div>
                `).join('');
            } else {
                remakesList.innerHTML = '<p style="color: #9ca3af;">No possible remakes detected.</p>';
            }
        }
        
        function checkForRemakes() {
            const deadPlayers = Object.entries(players).filter(([_, p]) => p.isDead);
            const newPlayers = Object.entries(players).filter(([_, p]) => p.isNew && !p.isDead);
            
            const possibleRemakes = [];
            
            deadPlayers.forEach(([deadName, deadPlayer]) => {
                newPlayers.forEach(([newName, newPlayer]) => {
                    if (deadPlayer.currentCity === newPlayer.currentCity) {
                        const nameSimilarity = calculateNameSimilarity(deadName, newName);
                        if (nameSimilarity > 0.5) {
                            possibleRemakes.push({
                                dead: deadName,
                                new: newName,
                                similarity: nameSimilarity,
                                city: deadPlayer.currentCity
                            });
                        }
                    }
                });
            });
            
            return possibleRemakes.sort((a, b) => b.similarity - a.similarity);
        }
        
        function calculateNameSimilarity(name1, name2) {
            const n1 = name1.toLowerCase();
            const n2 = name2.toLowerCase();
            
            if (n1 === n2) return 1.0;
            if (n1.includes(n2) || n2.includes(n1)) return 0.8;
            if (n2.match(new RegExp(`^${n1}\\d+$`)) || n1.match(new RegExp(`^${n2}\\d+$`))) return 0.9;
            
            let matches = 0;
            const minLen = Math.min(n1.length, n2.length);
            for (let i = 0; i < minLen; i++) {
                if (n1[i] === n2[i]) matches++;
            }
            
            return matches / Math.max(n1.length, n2.length);
        }
        
        function updateRecentDeaths() {
            const recentDeathsList = document.getElementById('recentDeathsList');
            
            const recentDeaths = Object.entries(players)
                .filter(([_, p]) => p.isDead && p.lastWords)
                .sort((a, b) => new Date(b[1].deathDate) - new Date(a[1].deathDate))
                .slice(0, 10);
            
            if (recentDeaths.length > 0) {
                recentDeathsList.innerHTML = recentDeaths.map(([name, player]) => `
                    <div style="background-color: #374151; border-radius: 4px; padding: 12px; margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <a href="#" onclick="openPlayerProfile('${name}'); return false;" 
                               class="player-link" style="font-weight: bold;">
                                ${name}
                            </a>
                            <span style="font-size: 0.875rem; color: #9ca3af;">
                                ${player.causeOfDeath} - ${new Date(player.deathDate).toLocaleDateString()}
                            </span>
                        </div>
                        <p style="font-size: 0.875rem; font-style: italic; color: #d1d5db;">
                            "${player.lastWords}"
                        </p>
                    </div>
                `).join('');
            } else {
                recentDeathsList.innerHTML = '<p style="color: #9ca3af;">No deaths with last words recorded yet.</p>';
            }
        }
        
        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        }
    </script>
</body>
</html>
